<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Execute scene</title>
  <link rel="stylesheet" href="pi-styles.css" />
</head>
<body>
  <div class="sdpi-wrapper">
    <div class="sdpi-item">
      <label class="sdpi-item-label">Scene</label>
      <select id="scene"></select>
    </div>

    <div class="sdpi-item">
      <button class="refresh-btn" id="refresh">Refresh scenes</button>
    </div>

    <div class="sdpi-item">
      <label class="sdpi-item-label">Icon</label>
      <div class="icon-picker" id="icon-picker"></div>
    </div>

    <div class="sdpi-item">
      <label class="sdpi-item-label">Port</label>
      <input type="number" id="port" placeholder="8423" min="1" max="65535" />
    </div>

    <div class="connection-error" id="connection-error">
      Cannot connect to Itsyhome. Make sure the app is running with the webhook server enabled (Pro feature).
    </div>

    <div class="sdpi-info">
      Select a HomeKit scene to execute when the button is pressed.
    </div>
  </div>

  <script src="pi-utils.js"></script>
  <script src="shared.js"></script>
  <script>
    const sceneSelect = document.getElementById("scene");
    const iconPicker = document.getElementById("icon-picker");
    const portInput = document.getElementById("port");
    const refreshBtn = document.getElementById("refresh");

    buildIconPicker(iconPicker, ICON_SETS.scene);
    initIconPicker(iconPicker, (value) => saveSettings({ iconStyle: value }));

    function onSettingsLoaded(settings) {
      portInput.value = settings.port || "";
      selectIcon(iconPicker, settings.iconStyle || "sparkle");
      hideConnectionError();
      populateSceneSelect(sceneSelect, settings.port, settings.scene);
    }

    sceneSelect.addEventListener("change", () => {
      saveSettings({ scene: sceneSelect.value });
    });

    portInput.addEventListener("change", () => {
      const port = portInput.value ? parseInt(portInput.value, 10) : undefined;
      saveSettings({ port });
      populateSceneSelect(sceneSelect, port, getSettings().scene);
    });

    refreshBtn.addEventListener("click", () => {
      hideConnectionError();
      populateSceneSelect(sceneSelect, getSettings().port, getSettings().scene);
    });
  </script>
</body>
</html>
