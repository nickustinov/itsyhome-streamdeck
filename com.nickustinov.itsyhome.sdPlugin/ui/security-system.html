<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Security System</title>
  <link rel="stylesheet" href="pi-styles.css" />
</head>
<body>
  <div class="sdpi-wrapper">
    <div class="sdpi-item">
      <label class="sdpi-item-label">Device</label>
      <select id="target"></select>
    </div>

    <div class="sdpi-item">
      <label class="sdpi-item-label">Label</label>
      <input type="text" id="label" placeholder="e.g. Home" />
    </div>

    <div class="sdpi-item">
      <label class="sdpi-item-label">Arm mode</label>
      <select id="armMode">
        <option value="0">Stay</option>
        <option value="1" selected>Away</option>
        <option value="2">Night</option>
      </select>
    </div>

    <div class="sdpi-item">
      <button class="refresh-btn" id="refresh">Refresh devices</button>
    </div>

    <div class="sdpi-item">
      <label class="sdpi-item-label">Disarmed color</label>
      <div id="disarmedColorPicker"></div>
    </div>

    <div class="sdpi-item">
      <label class="sdpi-item-label">Armed color</label>
      <div id="armedColorPicker"></div>
    </div>

    <div class="sdpi-item">
      <label class="sdpi-item-label">Port</label>
      <input type="number" id="port" placeholder="8423" min="1" max="65535" />
    </div>

    <div class="connection-error" id="connection-error">
      Cannot connect to Itsyhome. Make sure the app is running with the webhook server enabled (Pro feature).
    </div>

    <div class="sdpi-info">
      Toggle security system. Press to arm (selected mode) or disarm. Current state is shown under the label.
    </div>
  </div>

  <script src="pi-utils.js"></script>
  <script src="shared.js"></script>
  <script>
    const targetSelect = document.getElementById("target");
    const labelInput = document.getElementById("label");
    const armModeSelect = document.getElementById("armMode");
    const portInput = document.getElementById("port");
    const refreshBtn = document.getElementById("refresh");

    // Initialize color pickers (default: gray disarmed, green armed)
    const disarmedColorPicker = initColorPicker("disarmedColorPicker", "disarmedColor", "#8e8e93", saveSettings, getSettings);
    const armedColorPicker = initColorPicker("armedColorPicker", "armedColor", "#30d158", saveSettings, getSettings);

    function onSettingsLoaded(settings) {
      portInput.value = settings.port || "";
      labelInput.value = settings.label || "";
      armModeSelect.value = settings.armMode != null ? String(settings.armMode) : "1";
      hideConnectionError();
      populateTargetSelect(targetSelect, settings.port, settings.target, { types: ["security-system"], showGroups: false });
      disarmedColorPicker.setInitialValue();
      armedColorPicker.setInitialValue();
    }

    targetSelect.addEventListener("change", () => {
      const target = targetSelect.value;
      saveSettings({ target });

      // Auto-populate label with device name
      if (target) {
        const device = cachedDevices.find(d => {
          const deviceTarget = d.room ? `${d.room}/${d.name}` : d.name;
          return deviceTarget === target;
        });
        if (device) {
          labelInput.value = device.name;
          saveSettings({ label: device.name });
        }
      }
    });

    labelInput.addEventListener("change", () => {
      saveSettings({ label: labelInput.value });
    });

    armModeSelect.addEventListener("change", () => {
      const armMode = parseInt(armModeSelect.value, 10);
      saveSettings({ armMode });
    });

    portInput.addEventListener("change", () => {
      const port = portInput.value ? parseInt(portInput.value, 10) : undefined;
      saveSettings({ port });
      populateTargetSelect(targetSelect, port, getSettings().target, { types: ["security-system"], showGroups: false });
    });

    refreshBtn.addEventListener("click", () => {
      hideConnectionError();
      populateTargetSelect(targetSelect, getSettings().port, getSettings().target, { types: ["security-system"], showGroups: false });
    });
  </script>
</body>
</html>
